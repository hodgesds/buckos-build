load("//defs:package_defs.bzl", "download_source", "binary_package")
load("//defs:use_flags.bzl", "use_package", "set_use_flags", "use_dep")

download_source(
    name = "thunderbird-src",
    src_uri = "https://archive.mozilla.org/pub/thunderbird/releases/128.0/source/thunderbird-128.0.source.tar.xz",
    sha256 = "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2",
)

binary_package(
    name = "thunderbird",
    srcs = [":thunderbird-src"],
    version = "128.0",
    description = "Mozilla Thunderbird email client",
    homepage = "https://www.thunderbird.net/",
    license = "MPL-2.0",
    install_script = """
        cd $SRCS/thunderbird-*

        cat > mozconfig << 'MOZCONFIG'
ac_add_options --enable-application=comm/mail
ac_add_options --prefix=/usr
ac_add_options --libdir=/usr/lib
ac_add_options --enable-release
ac_add_options --enable-optimize
ac_add_options --disable-debug
ac_add_options --disable-tests
ac_add_options --enable-official-branding
ac_add_options --enable-update-channel=release
ac_add_options --with-system-zlib
ac_add_options --with-system-png
ac_add_options --with-system-jpeg
ac_add_options --enable-system-ffi
ac_add_options --enable-system-pixman
ac_add_options --enable-default-toolkit=cairo-gtk3-wayland
MOZCONFIG

        export MOZCONFIG="$PWD/mozconfig"
        export MOZ_NOSPAM=1
        export MOZBUILD_STATE_PATH="$PWD/.mozbuild"

        ./mach build
        DESTDIR="$OUT" ./mach install

        # Install desktop file
        mkdir -p "$OUT/usr/share/applications"
        install -Dm644 comm/mail/branding/thunderbird/net.thunderbird.Thunderbird.desktop \
            "$OUT/usr/share/applications/thunderbird.desktop"
    """,
    deps = [
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/core/musl:musl",
        "//packages/linux/desktop/gnome:gtk3",
        "//packages/linux/lang/python:python",
        "//packages/linux/lang/rust:rust",
        "//packages/linux/network/openssl:openssl",
    ],
    visibility = ["PUBLIC"],
)
