load("//defs:package_defs.bzl", "configure_make_package", "download_source")
load("//defs:use_flags.bzl", "use_package", "set_use_flags")

# =============================================================================
# dracut - Modern initramfs infrastructure
# =============================================================================
# Event-driven initramfs generator used by Fedora, RHEL, openSUSE.
# Supports modular configuration, network boot, encryption, LVM, RAID.

download_source(
    name = "dracut-src",
    src_uri = "https://github.com/dracut-ng/dracut-ng/archive/refs/tags/103.tar.gz",
    sha256 = "9fecb3e7f44c7e2e7c8db3b0c3a1e2d3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9",
)

configure_make_package(
    name = "dracut",
    source = ":dracut-src",
    version = "103",
    description = "Event-driven initramfs infrastructure (Fedora/RHEL default)",
    homepage = "https://github.com/dracut-ng/dracut-ng",
    license = "GPL-2.0-or-later",
    pre_configure = """
# dracut uses configure script
./configure \
    --prefix=/usr \
    --sysconfdir=/etc \
    --libdir=/usr/lib \
    --systemdsystemunitdir=/usr/lib/systemd/system \
    --bashcompletiondir=/usr/share/bash-completion/completions
""",
    configure_args = [],
    make_args = [],
    post_install = """
# Create configuration directories
mkdir -p $OUT/etc/dracut.conf.d
mkdir -p $OUT/usr/lib/dracut/modules.d

# Create default configuration
cat > $OUT/etc/dracut.conf << 'EOF'
# Dracut configuration file
# See dracut.conf(5) for options

# Compression algorithm (xz, gzip, lz4, zstd)
compress="zstd"

# Include firmware
hostonly="no"

# Add additional modules
# add_dracutmodules+=" lvm dm crypt "
EOF

# Install bash completion
mkdir -p $OUT/usr/share/bash-completion/completions
""",
    deps = [
        "//packages/linux/system/libs/kmod:kmod",
        "//packages/linux/core:bash",
        "//packages/linux/core:coreutils",
        "//packages/linux/core:util-linux",
        "//packages/linux/core:xz",
    ],
    visibility = ["PUBLIC"],
)

# Dracut modules for common boot scenarios
filegroup(
    name = "dracut-modules",
    srcs = [":dracut"],
    visibility = ["PUBLIC"],
)
