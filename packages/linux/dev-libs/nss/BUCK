load("//defs:package_defs.bzl", "download_source", "ebuild_package")

# NSS - Network Security Services
# Mozilla's PKI crypto library
download_source(
    name = "nss-src",
    src_uri = "https://archive.mozilla.org/pub/security/nss/releases/NSS_3_104_RTM/src/nss-3.104.tar.gz",
    sha256 = "e2763223622d1e76b98a43030873856f248af0a41b03b2fa2ca06a91bc50ac8e",
    signature_required = False,
)

ebuild_package(
    name = "nss",
    source = ":nss-src",
    version = "3.104",
    description = "Mozilla's Network Security Services implementing PKI support",
    homepage = "https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS",
    license = "MPL-2.0 OR GPL-2 OR LGPL-2.1",
    src_prepare = """
        cd nss
    """,
    src_configure = """
        # NSS uses make-based build system
        export BUILD_OPT=1
        export NSS_ENABLE_WERROR=0
        export NSS_USE_SYSTEM_SQLITE=1
        export NSDISTMODE=copy
        export NSS_DISABLE_GTESTS=1
        export USE_64=1
    """,
    src_compile = """
        cd nss
        export BUILD_OPT=1
        export NSS_ENABLE_WERROR=0
        export NSS_USE_SYSTEM_SQLITE=1
        export NSDISTMODE=copy
        export NSS_DISABLE_GTESTS=1
        export USE_64=1
        make -C coreconf
        make -C lib/dbm
        make -j$(nproc)
    """,
    src_install = """
        cd nss
        # NSS has a custom install
        mkdir -p "$DESTDIR/usr/lib" "$DESTDIR/usr/include/nss" "$DESTDIR/usr/bin"

        # Install libraries
        cp -P ../dist/Linux*/lib/*.so "$DESTDIR/usr/lib/" || true
        cp -P ../dist/Linux*/lib/*.chk "$DESTDIR/usr/lib/" || true

        # Install headers
        cp -r ../dist/public/nss/* "$DESTDIR/usr/include/nss/" || true
        cp -r ../dist/Linux*/include/* "$DESTDIR/usr/include/nss/" || true

        # Install utilities
        for util in certutil cmsutil crlutil modutil pk12util signtool signver ssltap; do
            [ -f ../dist/Linux*/bin/$util ] && cp ../dist/Linux*/bin/$util "$DESTDIR/usr/bin/" || true
        done
    """,
    rdepend = [
        "//packages/linux/dev-libs/nspr:nspr",
        "//packages/linux/core/zlib:zlib",
    ],
    bdepend = [
        "//packages/linux/dev-libs/nspr:nspr",
    ],
    visibility = ["PUBLIC"],
)
