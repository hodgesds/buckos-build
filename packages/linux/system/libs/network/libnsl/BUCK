load("//defs:package_defs.bzl", "download_source", "ebuild_package")

# libnsl - Public client interface for NIS(YP) in a IPv6 ready version
download_source(
    name = "libnsl-src",
    src_uri = "https://github.com/thkukuk/libnsl/releases/download/v2.0.1/libnsl-2.0.1.tar.xz",
    sha256 = "5c9e470b232a7acd3433491ac5221b4832f0c71318618dc6aa04dd05ffcd8fd9",
    auto_detect_signature=False,
)

ebuild_package(
    name = "libnsl",
    source = ":libnsl-src",
    version = "2.0.1",
    category = "system/libs/network",
    slot = "0/3",
    description = "Public client interface for NIS(YP) in a IPv6 ready version",
    homepage = "https://github.com/thkukuk/libnsl",
    license = "LGPL-2.1+",

    pre_configure = '''
# Find libtirpc headers from dependencies
for dep in $DEPS; do
    if [ -d "$dep/usr/include/tirpc" ]; then
        export CFLAGS="-I$dep/usr/include/tirpc $CFLAGS"
        export CPPFLAGS="-I$dep/usr/include/tirpc $CPPFLAGS"
        export PKG_CONFIG_PATH="$dep/usr/lib/pkgconfig:$dep/usr/lib64/pkgconfig:$PKG_CONFIG_PATH"
        echo "Found tirpc at $dep/usr/include/tirpc"
    fi
done
''',

    src_configure = '''
./configure \\
    --prefix=/usr \\
    --libdir=/usr/lib64 \\
    --enable-shared \\
    --disable-static \\
    CFLAGS="$CFLAGS" \\
    CPPFLAGS="$CPPFLAGS"
''',

    src_compile = '''
make -j$(nproc)
''',

    src_install = '''
make DESTDIR="$DESTDIR" install
find "$DESTDIR" -name '*.la' -delete
''',

    depend = [
        "//packages/linux/system/libs/ipc/libtirpc:libtirpc",
    ],
    visibility = ["PUBLIC"],
)
