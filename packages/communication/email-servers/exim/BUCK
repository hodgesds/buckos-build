load("//defs:package_defs.bzl", "download_source", "binary_package")

download_source(
    name = "exim-src",
    src_uri = "https://ftp.exim.org/pub/exim/exim4/exim-4.98.tar.xz",
    sha256 = "d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2",
)

binary_package(
    name = "exim",
    srcs = [":exim-src"],
    version = "4.98",
    description = "Highly configurable mail transfer agent",
    homepage = "https://www.exim.org/",
    license = "GPL-2+",
    install_script = """
        cd $SRCS/exim-*

        # Create Local/Makefile with build configuration
        mkdir -p Local
        cat > Local/Makefile << 'MAKEFILE'
BIN_DIRECTORY=/usr/bin
CONFIGURE_FILE=/etc/exim/exim.conf
EXIM_USER=exim
EXIM_GROUP=mail
SPOOL_DIRECTORY=/var/spool/exim
LOG_FILE_PATH=/var/log/exim/%s
SUPPORT_TLS=yes
USE_OPENSSL=yes
TLS_LIBS=-lssl -lcrypto
PCRE2_CONFIG=yes
LOOKUP_SQLITE=yes
LOOKUP_LDAP=yes
LDAP_LIB_TYPE=OPENLDAP2
AUTH_CRAM_MD5=yes
AUTH_DOVECOT=yes
AUTH_PLAINTEXT=yes
AUTH_SPA=yes
MAKEFILE

        make
        make DESTDIR="$OUT" install

        # Create directories
        mkdir -p "$OUT/etc/exim"
        mkdir -p "$OUT/var/spool/exim"
        mkdir -p "$OUT/var/log/exim"

        # Install default config
        install -Dm644 src/configure.default "$OUT/etc/exim/exim.conf"
    """,
    deps = [
        "//packages/core:musl",
        "//packages/network/openssl:openssl",
    ],
    visibility = ["PUBLIC"],
)
