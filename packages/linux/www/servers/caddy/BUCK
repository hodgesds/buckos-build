load("//defs:package_defs.bzl", "download_source", "binary_package")
load("//defs:use_flags.bzl", "use_package", "set_use_flags", "use_dep")

# caddy - Fast, multi-platform web server with automatic HTTPS
#
# USE flags:
#   This is a pre-built Go binary, minimal USE flag customization available

download_source(
    name = "caddy-src",
    src_uri = "https://github.com/caddyserver/caddy/releases/download/v2.8.4/caddy_2.8.4_linux_amd64.tar.gz",
    sha256 = "a7e8306c54138cf88e371c5ec0caf7baf142ecc1d60a30897dfb67d65d3748c8",
)

binary_package(
    name = "caddy",
    srcs = [":caddy-src"],
    version = "2.8.4",
    description = "Fast, multi-platform web server with automatic HTTPS",
    homepage = "https://caddyserver.com/",
    license = "Apache-2.0",
    install_script = """
cd $SRCS

# Install binary
install -Dm755 caddy "$DESTDIR/usr/bin/caddy"

# Create configuration directories
mkdir -p "$DESTDIR/etc/caddy"
mkdir -p "$DESTDIR/var/lib/caddy"
mkdir -p "$DESTDIR/var/log/caddy"

# Create default Caddyfile
cat > "$DESTDIR/etc/caddy/Caddyfile" << 'EOF'
# Global options
{
    admin off
}

# Default site
:80 {
    root * /var/www/html
    file_server
}
EOF

# Create default web root
mkdir -p "$DESTDIR/var/www/html"
""",
    deps = [
    ],
    visibility = ["PUBLIC"],
)
