load("//defs:package_defs.bzl", "download_source", "configure_make_package")
load("//defs:use_flags.bzl", "use_package", "set_use_flags")

# Download source - explicitly created with PUBLIC visibility for reuse
download_source(
    name = "busybox-src",
    src_uri = "https://busybox.net/downloads/busybox-1.36.1.tar.bz2",
    sha256 = "6917569008ed8665c736b1d5b2dbbf8d863edac2478a1f05e998d535dea5b017",
    visibility = ["PUBLIC"],
)

configure_make_package(
    name = "busybox",
    source = ":busybox-src",
    version = "1.36.1",
    description = "BusyBox combines tiny versions of many common UNIX utilities into a single small executable",
    homepage = "https://busybox.net/",
    license = "GPL-2.0",
    pre_configure = """
# Use default config and enable static linking for init
make defconfig
sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/' .config
# Disable tc which has kernel header incompatibilities
sed -i 's/CONFIG_TC=y/# CONFIG_TC is not set/' .config
""",
    make_args = [
        "CONFIG_PREFIX=$DESTDIR",
    ],
    post_install = """
# Create symlinks in standard locations
mkdir -p "$DESTDIR/bin" "$DESTDIR/sbin"
cd "$DESTDIR"
# busybox installs with CONFIG_PREFIX, symlinks are auto-created
""",
    visibility = ["PUBLIC"],
)
