load("//defs:package_defs.bzl", "download_source", "configure_make_package")
load("//defs:use_flags.bzl", "use_package", "set_use_flags")

# virtme-ng - Run kernels quickly inside VMs
download_source(
    name = "virtme-ng-src",
    src_uri = "https://github.com/arighi/virtme-ng/archive/refs/tags/v1.31.tar.gz",
    sha256 = "e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2",
)

# USE flags: See use_flags.bzl for available flags

configure_make_package(
    name = "virtme-ng",
    source = ":virtme-ng-src",
    version = "1.31",
    description = "Quickly run kernels inside a virtualized snapshot of your live system",
    homepage = "https://github.com/arighi/virtme-ng",
    license = "GPL-2.0",
    pre_configure = """
# Build with pip/setuptools
python3 -m pip install --no-build-isolation --prefix=/usr --root="$DESTDIR" .
    """,
    post_install = """
#!/bin/bash
set -e

# Create symlinks for compatibility
mkdir -p "$DESTDIR/usr/bin"
ln -sf virtme-ng "$DESTDIR/usr/bin/vng" 2>/dev/null || true

# Install default configuration
mkdir -p "$DESTDIR/etc/virtme-ng"
cat > "$DESTDIR/etc/virtme-ng/virtme-ng.conf" << 'EOF'
# virtme-ng default configuration
[virtme]
# Default number of CPUs
cpus = 2
# Default memory
memory = 2G
# Enable KVM acceleration if available
kvm = true
EOF
    """,
    deps = [
        "//packages/linux/lang/python:python",
        "//packages/linux/emulation/hypervisors/qemu:qemu",
    ],
    visibility = ["PUBLIC"],
)

# virtme (original) for compatibility
download_source(
    name = "virtme-src",
    src_uri = "https://github.com/amluto/virtme/archive/refs/tags/v1.0.tar.gz",
    sha256 = "f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3",
)

# USE flags: See use_flags.bzl for available flags

configure_make_package(
    name = "virtme",
    source = ":virtme-src",
    version = "1.0",
    description = "Original virtme - Run a kernel inside a virtual machine",
    homepage = "https://github.com/amluto/virtme",
    license = "GPL-2.0",
    pre_configure = """
python3 setup.py build
    """,
    post_install = """
#!/bin/bash
set -e

python3 setup.py install --prefix=/usr --root="$DESTDIR"
    """,
    deps = [
        "//packages/linux/lang/python:python",
        "//packages/linux/emulation/hypervisors/qemu:qemu",
    ],
    visibility = ["PUBLIC"],
)
