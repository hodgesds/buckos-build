load("//defs:package_defs.bzl", "configure_make_package", "download_source")
load("//defs:use_flags.bzl", "use_package", "set_use_flags")

# =============================================================================
# mkinitcpio - Arch Linux initramfs creation utility
# =============================================================================
# Modular initramfs generator with hook-based system.
# Known for simplicity, speed, and excellent documentation.

download_source(
    name = "mkinitcpio-src",
    src_uri = "https://gitlab.archlinux.org/archlinux/mkinitcpio/mkinitcpio/-/archive/v38/mkinitcpio-v38.tar.gz",
    sha256 = "2a48b25553a4d661d99904952c0a16419a0a7466f7487bd44397da770558ec7d",
)

configure_make_package(
    name = "mkinitcpio",
    source = ":mkinitcpio-src",
    version = "38",
    description = "Modular initramfs image creation utility (Arch Linux default)",
    homepage = "https://gitlab.archlinux.org/archlinux/mkinitcpio/mkinitcpio",
    license = "GPL-2.0",
    pre_configure = "true",  # Uses Makefile directly
    configure_args = [],
    make_args = [
        "PREFIX=/usr",
    ],
    post_install = """
# Install using make
make DESTDIR=$OUT PREFIX=/usr install

# Create configuration directories
mkdir -p $OUT/etc/mkinitcpio.d
mkdir -p $OUT/usr/lib/initcpio/hooks
mkdir -p $OUT/usr/lib/initcpio/install

# Create default configuration
cat > $OUT/etc/mkinitcpio.conf << 'EOF'
# mkinitcpio configuration file

# MODULES - Modules to add to the initramfs
MODULES=()

# BINARIES - Additional binaries to add
BINARIES=()

# FILES - Additional files to add
FILES=()

# HOOKS - Build hooks to run
# Order matters: base and udev should come first
HOOKS=(base udev autodetect modconf kms keyboard keymap consolefont block filesystems fsck)

# COMPRESSION - Compression algorithm
COMPRESSION="zstd"
#COMPRESSION_OPTIONS=()
EOF

# Create preset directory
mkdir -p $OUT/etc/mkinitcpio.d
""",
    deps = [
        "//packages/linux/system/libs/kmod:kmod",
        "//packages/linux/core/bash:bash",
        "//packages/linux/system/apps/coreutils:coreutils",
        "//packages/linux/core/util-linux:util-linux",
        "//packages/linux/core/xz:xz",
    ],
    visibility = ["PUBLIC"],
)

# mkinitcpio-busybox - Busybox for use in initramfs
configure_make_package(
    name = "mkinitcpio-busybox",
    source = "//packages/linux/core/busybox:busybox-src",
    version = "1.36.1",
    description = "Busybox configured for mkinitcpio initramfs",
    homepage = "https://busybox.net/",
    license = "GPL-2.0",
    pre_configure = """
# Use minimal config for initramfs
make defconfig
# Enable static linking
sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/' .config
""",
    configure_args = [],
    make_args = [],
    post_install = """
mkdir -p $OUT/usr/lib/initcpio
install -m755 busybox $OUT/usr/lib/initcpio/busybox
""",
    visibility = ["PUBLIC"],
)
