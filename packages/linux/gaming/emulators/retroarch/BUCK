# RetroArch - Multi-system emulator frontend
# Unified interface for libretro cores supporting dozens of gaming systems

load("//defs:package_defs.bzl", "configure_make_package", "download_source")
load("//defs:use_flags.bzl", "use_package", "set_use_flags")

download_source(
    name = "retroarch-src",
    src_uri = "https://github.com/libretro/RetroArch/archive/refs/tags/v1.19.1.tar.gz",
    sha256 = "504a3a8a6e5861eb43a61be8339f61183e7ea940c1ff68ac2a2f57d35c67f8ff",
)

# USE flags: See use_flags.bzl for available flags

configure_make_package(
    name = "retroarch",
    source = ":retroarch-src",
    version = "1.19.1",
    description = "Multi-system emulator frontend using libretro cores",
    homepage = "https://www.retroarch.com/",
    license = "GPL-3.0",
    configure_args = [
        "--prefix=/usr",
        "--enable-vulkan",
        "--enable-opengl",
        "--enable-wayland",
        "--enable-x11",
        "--enable-pulse",
        "--enable-alsa",
        "--enable-ffmpeg",
        "--enable-networking",
        "--enable-threads",
        "--disable-builtinflac",
        "--disable-builtinzlib",
    ],
    post_install = """
#!/bin/bash
set -e

# Install assets and configuration
mkdir -p "$DESTDIR/usr/share/retroarch/assets"
mkdir -p "$DESTDIR/usr/share/retroarch/cores"
mkdir -p "$DESTDIR/etc/retroarch"

# Create default configuration
cat > "$DESTDIR/etc/retroarch/retroarch.cfg" << 'EOF'
# RetroArch default configuration
video_driver = "vulkan"
audio_driver = "pulse"
menu_driver = "ozone"
input_driver = "udev"

# Directories
system_directory = "~/.config/retroarch/system"
savefile_directory = "~/.config/retroarch/saves"
savestate_directory = "~/.config/retroarch/states"
screenshot_directory = "~/.config/retroarch/screenshots"
libretro_directory = "/usr/share/retroarch/cores"
assets_directory = "/usr/share/retroarch/assets"

# Performance
video_vsync = "true"
video_threaded = "true"
video_max_swapchain_images = "3"
EOF

# Install desktop entry
mkdir -p "$DESTDIR/usr/share/applications"
cat > "$DESTDIR/usr/share/applications/retroarch.desktop" << 'EOF'
[Desktop Entry]
Name=RetroArch
Comment=Multi-system emulator frontend
Exec=retroarch
Icon=retroarch
Terminal=false
Type=Application
Categories=Game;Emulator;
Keywords=emulator;retro;gaming;
EOF

# Install icon
mkdir -p "$DESTDIR/usr/share/icons/hicolor/scalable/apps"
cp media/retroarch.svg "$DESTDIR/usr/share/icons/hicolor/scalable/apps/" 2>/dev/null || true
    """,
    deps = [
        "//packages/linux/gaming/libraries/sdl2:sdl2",
        "//packages/linux/gaming/libraries/vulkan-tools:vulkan-tools",
    ],
    visibility = ["PUBLIC"],
)
