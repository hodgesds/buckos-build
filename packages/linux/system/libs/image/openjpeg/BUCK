load("//defs:package_defs.bzl", "cmake_package")
load("//defs:use_flags.bzl", "use_package", "set_use_flags")

use_package(
    name = "openjpeg",
    version = "2.5.2",
    src_uri = "https://github.com/uclouvain/openjpeg/archive/refs/tags/v2.5.2.tar.gz",
    sha256 = "90e3896fed910c376aaf79cdd98bdfdaf98c6472efd8e1debf0a854938cbda6a",
    auto_detect_signature = False,
    description = "JPEG 2000 codec library",
    homepage = "https://www.openjpeg.org/",
    license = "BSD-2-Clause",

    # USE flags this package supports
    iuse = [
        "static-libs",  # Build static libraries
        "png",          # PNG support for conversions
        "tiff",         # TIFF support for conversions
        "lcms2",        # Color management support
        "doc",          # Build documentation
        "test",         # Build test suite
    ],

    # Default USE flags
    use_defaults = ["png", "tiff"],

    # CMake-based build - use pre_configure to set cmake args
    use_configure = {},

    use_deps = {
        "png": ["//packages/linux/system/libs/image/libpng:libpng"],
        "tiff": ["//packages/linux/system/libs/image/libtiff:libtiff"],
        "lcms2": ["//packages/linux/system/libs/color/lcms2:lcms2"],
    },

    configure_args = [],
    deps = [],

    pre_configure = """
# USE flags: static-libs, png, tiff, lcms2, doc, test
# This is a CMake-based package

CMAKE_ARGS="-DCMAKE_INSTALL_PREFIX=/usr"

if [ "${USE_static_libs}" = "1" ]; then
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_SHARED_LIBS=ON -DBUILD_STATIC_LIBS=ON"
else
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_SHARED_LIBS=ON -DBUILD_STATIC_LIBS=OFF"
fi

if [ "${USE_png}" = "1" ]; then
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_PNG=ON"
else
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_PNG=OFF"
fi

if [ "${USE_tiff}" = "1" ]; then
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_TIFF=ON"
else
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_TIFF=OFF"
fi

if [ "${USE_lcms2}" = "1" ]; then
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_LCMS2=ON"
else
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_LCMS2=OFF"
fi

if [ "${USE_doc}" = "1" ]; then
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_DOC=ON"
else
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_DOC=OFF"
fi

if [ "${USE_test}" = "1" ]; then
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_TESTING=ON"
else
    CMAKE_ARGS="$CMAKE_ARGS -DBUILD_TESTING=OFF"
fi

# Run cmake
cmake $CMAKE_ARGS -B build -S .
""",

    # Override configure step since we're using cmake
    configure_command = "true",  # Skip configure, we did it in pre_configure

    # Use cmake build
    make_command = "cmake --build build",
    install_command = "cmake --install build --prefix $DESTDIR/usr",

    visibility = ["PUBLIC"],
)
