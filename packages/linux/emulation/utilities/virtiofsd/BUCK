load("//defs:package_defs.bzl", "download_source", "configure_make_package")
load("//defs:use_flags.bzl", "use_package", "set_use_flags")

# virtiofsd - virtio-fs vhost-user device daemon
download_source(
    name = "virtiofsd-src",
    src_uri = "https://gitlab.com/virtio-fs/virtiofsd/-/archive/v1.11.1/virtiofsd-v1.11.1.tar.gz",
    sha256 = "e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6",
)

# USE flags: See use_flags.bzl for available flags

configure_make_package(
    name = "virtiofsd",
    source = ":virtiofsd-src",
    version = "1.11.1",
    description = "virtio-fs vhost-user device daemon for sharing directories with guests",
    homepage = "https://virtio-fs.gitlab.io/",
    license = "Apache-2.0 AND BSD-3-Clause",
    env = {
        "CARGO_HOME": "/tmp/cargo",
    },
    pre_configure = """
cargo build --release
    """,
    post_install = """
#!/bin/bash
set -e

mkdir -p "$DESTDIR/usr/lib/qemu"
install -m 0755 target/release/virtiofsd "$DESTDIR/usr/lib/qemu/"

# Also create symlink in /usr/bin for convenience
mkdir -p "$DESTDIR/usr/bin"
ln -sf /usr/lib/qemu/virtiofsd "$DESTDIR/usr/bin/virtiofsd"

# Install systemd unit template
mkdir -p "$DESTDIR/usr/lib/systemd/system"
cat > "$DESTDIR/usr/lib/systemd/system/virtiofsd@.service" << 'EOF'
[Unit]
Description=virtiofsd - virtio-fs vhost-user device daemon for %i

[Service]
Type=simple
ExecStart=/usr/lib/qemu/virtiofsd --socket-path=/run/virtiofsd/%i.sock --shared-dir=/var/lib/virtiofsd/%i
RuntimeDirectory=virtiofsd
StateDirectory=virtiofsd/%i

[Install]
WantedBy=multi-user.target
EOF
    """,
    deps = [
        "//packages/linux/lang/rust:rust",
        "//packages/linux/core:libcap-ng",
        "//packages/linux/core:libseccomp",
    ],
    visibility = ["PUBLIC"],
)
