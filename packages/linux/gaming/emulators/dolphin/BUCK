# Dolphin Emulator - GameCube and Wii emulator
# High-compatibility emulator with excellent performance

load("//defs:package_defs.bzl", "configure_make_package", "download_source")
load("//defs:use_flags.bzl", "use_package", "set_use_flags")

download_source(
    name = "dolphin-src",
    src_uri = "https://github.com/dolphin-emu/dolphin/archive/refs/tags/2409.tar.gz",
    sha256 = "9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1",
)

# USE flags: See use_flags.bzl for available flags

configure_make_package(
    name = "dolphin",
    source = ":dolphin-src",
    version = "2409",
    description = "GameCube and Wii emulator",
    homepage = "https://dolphin-emu.org/",
    license = "GPL-2.0",
    pre_configure = """
# Dolphin uses CMake
mkdir -p build
cd build
cmake .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DENABLE_VULKAN=ON \
    -DENABLE_X11=ON \
    -DENABLE_WAYLAND=ON \
    -DENABLE_PULSEAUDIO=ON \
    -DENABLE_ALSA=ON \
    -DENABLE_LLVM=OFF \
    -DUSE_SHARED_ENET=OFF \
    -DENABLE_ANALYTICS=OFF
    """,
    configure_args = [],
    post_install = """
#!/bin/bash
set -e

cd "$SRC_DIR/build"
make -j$(nproc)
make DESTDIR="$DESTDIR" install

# Create udev rules for GameCube adapter
mkdir -p "$DESTDIR/usr/lib/udev/rules.d"
cat > "$DESTDIR/usr/lib/udev/rules.d/51-dolphin.rules" << 'EOF'
# GameCube Controller Adapter
SUBSYSTEM=="usb", ENV{DEVTYPE}=="usb_device", ATTRS{idVendor}=="057e", ATTRS{idProduct}=="0337", MODE="0666", TAG+="uaccess"

# Wiimote (with Bluetooth passthrough)
SUBSYSTEM=="usb", ENV{DEVTYPE}=="usb_device", ATTRS{idVendor}=="057e", ATTRS{idProduct}=="0306", MODE="0666", TAG+="uaccess"
SUBSYSTEM=="usb", ENV{DEVTYPE}=="usb_device", ATTRS{idVendor}=="057e", ATTRS{idProduct}=="0330", MODE="0666", TAG+="uaccess"
EOF

# Desktop entry should already be installed by CMake
# Install additional metadata
mkdir -p "$DESTDIR/usr/share/doc/dolphin-emu"
cat > "$DESTDIR/usr/share/doc/dolphin-emu/README" << 'EOF'
Dolphin Emulator - GameCube and Wii Emulator

Configuration: ~/.config/dolphin-emu/
Game data: Place your games in any directory and add it in the GUI

Controller setup:
- GameCube: Use the official USB adapter or map to keyboard/gamepad
- Wii: Use real Wiimotes via Bluetooth or emulate with gamepad

Performance tips:
- Use Vulkan backend for best performance
- Enable Dual Core mode
- Use native resolution or 2x for good quality/performance balance
EOF
    """,
    deps = [
        "//packages/linux/gaming/libraries/sdl2:sdl2",
        "//packages/linux/gaming/libraries/vulkan-tools:vulkan-tools",
    ],
    visibility = ["PUBLIC"],
)
