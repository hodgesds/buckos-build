load("//defs:package_defs.bzl", "download_source", "autotools_package")
load("//defs:use_flags.bzl", "set_use_flags")

# efivar - Tools and library for manipulating EFI variables
download_source(
    name = "efivar-src",
    src_uri = "https://github.com/rhboot/efivar/archive/refs/tags/39.tar.gz",
    sha256 = "c9edd15f2eeeea63232f3e669a48e992c7be9aff57ee22672ac31f5eca1609a6",
    signature_required = False,
)

autotools_package(
    name = "efivar",
    source = ":efivar-src",
    version = "39",
    description = "Tools and library for manipulating EFI variables",
    homepage = "https://github.com/rhboot/efivar",
    license = "LGPL-2.1",
    pre_configure = """
# efivar doesn't use autotools, just make
# Set environment variables for the build (from Gentoo ebuild)
export PREFIX=/usr
export LIBDIR=/usr/lib64
export ERRORS=  # Avoid -Werror
""",
    configure_args = [],
    make_args = [
        "PREFIX=/usr",
        "LIBDIR=/usr/lib64",
        "HOST_MARCH=",
    ],
    post_install = """
# Install efivar (no autotools, use make install directly)
make DESTDIR=$DESTDIR PREFIX=/usr LIBDIR=/usr/lib64 install
""",
    deps = [
        "//packages/linux/system/libs/ipc/popt:popt",
    ],
    visibility = ["PUBLIC"],
)
