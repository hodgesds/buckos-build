load("//defs:package_defs.bzl", "download_source", "binary_package", "autotools_package")
load("//defs:use_flags.bzl", "set_use_flags", "use_dep")

# lmbench - Suite of portable micro-benchmarks
#
# USE flags: (minimal flags for this benchmark)

download_source(
    name = "lmbench-src",
    src_uri = "https://github.com/intel/lmbench/archive/refs/heads/master.tar.gz",
    sha256 = "45e6d38788df37f9a6bf6e31bd9b13a25fc8603beb672e38199ac7564010ae12",
)

binary_package(
    name = "lmbench",
    srcs = [":lmbench-src"],
    version = "3.0-a9",
    description = "Suite of portable micro-benchmarks for UNIX/POSIX systems",
    homepage = "http://lmbench.sourceforge.net/",
    license = "GPL-2.0",
    build_deps = [
        "//packages/linux/system/libs/ipc/libtirpc:libtirpc",
    ],
    install_script = """
        cd $SRCS

        # Find libtirpc in build deps
        TIRPC_INC=""
        TIRPC_LIB=""
        for dep in $BUILD_DEPS; do
            if [ -d "$dep/usr/include/tirpc" ]; then
                TIRPC_INC="$dep/usr/include/tirpc"
                echo "Found tirpc includes at $TIRPC_INC"
            fi
            if [ -d "$dep/usr/lib" ]; then
                TIRPC_LIB="$dep/usr/lib"
            fi
        done

        # Fix for GCC 14+ stricter C standards and add libtirpc headers for rpc/rpc.h
        # lmbench's Makefile doesn't honor CFLAGS well, so patch the source
        sed -i 's|#include.*<rpc/rpc.h>|#include <tirpc/rpc/rpc.h>|g' src/bench.h

        export CFLAGS="-Wno-error=implicit-function-declaration -Wno-error=implicit-int -Wno-error=int-conversion -I$TIRPC_INC"
        export LDFLAGS="-L$TIRPC_LIB -ltirpc"

        # Also set CC with the flags since lmbench's makefile is old
        export CC="gcc $CFLAGS"
        export LDLIBS="-ltirpc"

        make build CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS" LDLIBS="$LDLIBS"

        mkdir -p $OUT/usr/bin
        cp bin/*/lmbench $OUT/usr/bin/ 2>/dev/null || true
        cp bin/*/lat_* $OUT/usr/bin/ 2>/dev/null || true
        cp bin/*/bw_* $OUT/usr/bin/ 2>/dev/null || true
    """,
    visibility = ["PUBLIC"],
)
