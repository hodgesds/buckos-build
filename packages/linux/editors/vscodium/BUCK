load("//defs:package_defs.bzl", "download_source", "binary_package", "autotools_package")
load("//defs:use_flags.bzl", "set_use_flags", "use_dep")

download_source(
    name = "vscodium-src",
    src_uri = "https://github.com/VSCodium/vscodium/releases/download/1.106.37943/VSCodium-linux-x64-1.106.37943.tar.gz",
    sha256 = "3fbd5a7885626aa4a83297e0b4a3d902c725b1674122f33d0ef02863c726e4ec",
    signature_required = False,
)

binary_package(
    name = "vscodium",
    srcs = [":vscodium-src"],
    version = "1.106.37943",
    description = "Free/Libre Open Source Software binaries of VS Code - community-driven, telemetry-free",
    homepage = "https://vscodium.com/",
    license = "MIT",
    install_script = """
        # Source files are already extracted to $SRCS
        cd $SRCS

        # Install to destination
        mkdir -p "$OUT/opt/vscodium"
        mkdir -p "$OUT/usr/bin"
        mkdir -p "$OUT/usr/share/applications"
        mkdir -p "$OUT/usr/share/icons/hicolor/128x128/apps"
        mkdir -p "$OUT/usr/share/icons/hicolor/256x256/apps"
        mkdir -p "$OUT/usr/share/icons/hicolor/512x512/apps"
        mkdir -p "$OUT/usr/share/pixmaps"
        mkdir -p "$OUT/usr/share/mime/packages"
        mkdir -p "$OUT/usr/share/bash-completion/completions"
        mkdir -p "$OUT/usr/share/zsh/site-functions"

        # Copy VSCodium application files
        cp -r * "$OUT/opt/vscodium/" 2>/dev/null || true

        # Remove the tarball from opt if it was copied
        rm -f "$OUT/opt/vscodium/"*.tar.gz

        # Create wrapper script
        cat > "$OUT/usr/bin/vscodium" << 'WRAPPER'
#!/bin/sh
VSCODIUM_PATH="/opt/vscodium"
ELECTRON_RUN_AS_NODE=1 exec "$VSCODIUM_PATH/codium" "$@"
WRAPPER
        chmod +x "$OUT/usr/bin/vscodium"

        # Create codium symlink for compatibility
        ln -sf vscodium "$OUT/usr/bin/codium"

        # Copy icons
        if [ -f "$OUT/opt/vscodium/resources/app/resources/linux/code.png" ]; then
            cp "$OUT/opt/vscodium/resources/app/resources/linux/code.png" "$OUT/usr/share/pixmaps/vscodium.png"
        fi

        # Install various icon sizes if available
        for size in 128 256 512; do
            icon_src="$OUT/opt/vscodium/resources/app/resources/linux/code.png"
            if [ -f "$icon_src" ]; then
                cp "$icon_src" "$OUT/usr/share/icons/hicolor/${size}x${size}/apps/vscodium.png"
            fi
        done

        # Create desktop entry
        cat > "$OUT/usr/share/applications/vscodium.desktop" << 'DESKTOP'
[Desktop Entry]
Name=VSCodium
Comment=Code Editing. Redefined.
GenericName=Text Editor
Exec=/opt/vscodium/codium --unity-launch %F
Icon=vscodium
Type=Application
StartupNotify=true
StartupWMClass=VSCodium
Categories=TextEditor;Development;IDE;
MimeType=text/plain;inode/directory;application/x-code-workspace;
Actions=new-empty-window;
Keywords=vscode;vscodium;editor;code;ide;development;

[Desktop Action new-empty-window]
Name=New Empty Window
Exec=/opt/vscodium/codium --new-window %F
Icon=vscodium
DESKTOP

        # Create URL handler desktop entry
        cat > "$OUT/usr/share/applications/vscodium-url-handler.desktop" << 'DESKTOP'
[Desktop Entry]
Name=VSCodium - URL Handler
Comment=Code Editing. Redefined.
GenericName=Text Editor
Exec=/opt/vscodium/codium --open-url %U
Icon=vscodium
Type=Application
NoDisplay=true
StartupNotify=true
Categories=Utility;TextEditor;Development;IDE;
MimeType=x-scheme-handler/vscodium;
Keywords=vscode;vscodium;
DESKTOP

        # Create MIME type definitions
        cat > "$OUT/usr/share/mime/packages/vscodium-workspace.xml" << 'MIME'
<?xml version="1.0" encoding="UTF-8"?>
<mime-info xmlns="http://www.freedesktop.org/standards/shared-mime-info">
  <mime-type type="application/x-code-workspace">
    <comment>VSCodium Workspace</comment>
    <icon name="vscodium"/>
    <glob-deleteall/>
    <glob pattern="*.code-workspace"/>
  </mime-type>
</mime-info>
MIME

        # Create bash completion
        cat > "$OUT/usr/share/bash-completion/completions/vscodium" << 'BASH'
# bash completion for vscodium

_vscodium() {
    local cur prev
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    case "$prev" in
        -r|--reuse-window|-g|--goto|-d|--diff|-m|--merge|-n|--new-window)
            COMPREPLY=($(compgen -f -- "$cur"))
            return 0
            ;;
        --locale)
            COMPREPLY=($(compgen -W "de en en-US es fr it ja ko ru zh-CN zh-TW bg hu pt-br tr" -- "$cur"))
            return 0
            ;;
        --log)
            COMPREPLY=($(compgen -W "critical error warn info debug trace off" -- "$cur"))
            return 0
            ;;
    esac

    if [[ "$cur" == -* ]]; then
        COMPREPLY=($(compgen -W "--help --version --new-window --reuse-window --goto --diff --merge --wait --locale --user-data-dir --profile --extensions-dir --list-extensions --show-versions --category --install-extension --uninstall-extension --enable-proposed-api --verbose --log --status --prof-startup --disable-extensions --disable-extension --sync --inspect-extensions --inspect-brk-extensions --disable-gpu --max-memory --telemetry" -- "$cur"))
        return 0
    fi

    COMPREPLY=($(compgen -f -- "$cur"))
}

complete -F _vscodium vscodium
complete -F _vscodium codium
BASH

        # Create zsh completion
        cat > "$OUT/usr/share/zsh/site-functions/_vscodium" << 'ZSH'
#compdef vscodium codium

_vscodium() {
    _arguments \
        '(-h --help)'{-h,--help}'[Print usage]' \
        '(-v --version)'{-v,--version}'[Print version]' \
        '(-n --new-window)'{-n,--new-window}'[Open a new window]' \
        '(-r --reuse-window)'{-r,--reuse-window}'[Reuse existing window]' \
        '(-g --goto)'{-g,--goto}'[Open file at path:line:column]' \
        '(-d --diff)'{-d,--diff}'[Compare two files]' \
        '(-m --merge)'{-m,--merge}'[Perform a three-way merge]' \
        '(-w --wait)'{-w,--wait}'[Wait for files to be closed]' \
        '--locale[Locale to use]:locale:(de en en-US es fr it ja ko ru zh-CN zh-TW bg hu pt-br tr)' \
        '--user-data-dir[User data directory]:dir:_files -/' \
        '--profile[Open with profile]:profile:' \
        '--extensions-dir[Extensions directory]:dir:_files -/' \
        '--list-extensions[List installed extensions]' \
        '--show-versions[Show versions with --list-extensions]' \
        '--category[Filter extensions by category]:category:' \
        '--install-extension[Install extension]:extension:' \
        '--uninstall-extension[Uninstall extension]:extension:' \
        '--enable-proposed-api[Enable proposed API]:extension:' \
        '--verbose[Print verbose output]' \
        '--log[Log level]:level:(critical error warn info debug trace off)' \
        '(-s --status)'{-s,--status}'[Print process usage and diagnostics]' \
        '--prof-startup[Run CPU profiler during startup]' \
        '--disable-extensions[Disable all extensions]' \
        '--disable-extension[Disable specific extension]:extension:' \
        '--sync[Turn sync on or off]:state:(on off)' \
        '--inspect-extensions[Debug extensions]:port:' \
        '--inspect-brk-extensions[Debug extensions with break]:port:' \
        '--disable-gpu[Disable GPU acceleration]' \
        '--max-memory[Max memory for window in MB]:memory:' \
        '--telemetry[Show telemetry status]' \
        '*:file:_files'
}

_vscodium "$@"
ZSH

        # Set correct permissions
        chmod +x "$OUT/opt/vscodium/codium"
        chmod 4755 "$OUT/opt/vscodium/chrome-sandbox" 2>/dev/null || true

        # Make all .so files executable
        find "$OUT/opt/vscodium" -name "*.so*" -exec chmod +x {} \\; 2>/dev/null || true
    """,
    deps = [
        "//packages/linux/dev-libs/glib:glib",
        "//packages/linux/desktop/gtk:gtk3",
        "//packages/linux/system/libs/input/libxkbcommon:libxkbcommon",
        "//packages/linux/dev-libs/nss:nss",
        "//packages/linux/dev-libs/nspr:nspr",
        "//packages/linux/audio/daemons/alsa-lib:alsa-lib",
        "//packages/linux/audio/daemons/pulseaudio:pulseaudio",
        "//packages/linux/system/libs/ipc/dbus:dbus",
        "//packages/linux/system/libs/data/expat:expat",
        "//packages/linux/desktop/libdrm:libdrm",
        # "//packages/linux/desktop/mesa:mesa",  # Disabled: requires Python mako module
    ],
    visibility = ["PUBLIC"],
)
