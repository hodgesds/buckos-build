# MangoHud - Vulkan and OpenGL overlay for monitoring performance
# Displays FPS, CPU/GPU usage, temperatures, and more

load("//defs:package_defs.bzl", "autotools_package", "download_source", "autotools_package")
load("//defs:use_flags.bzl", "set_use_flags")

download_source(
    name = "mangohud-src",
    src_uri = "https://github.com/flightlessmango/MangoHud/archive/refs/tags/v0.7.2.tar.gz",
    sha256 = "67d2425c0cc634574d8bd8a924e0e1a2e909b47ed9b8c02029b5baffe46657fc",
)

# USE flags: See use_flags.bzl for available flags

autotools_package(
    name = "mangohud",
    source = ":mangohud-src",
    version = "0.7.2",
    description = "Vulkan and OpenGL overlay for monitoring FPS, temperatures, CPU/GPU load",
    homepage = "https://github.com/flightlessmango/MangoHud",
    license = "MIT",
    pre_configure = """
# MangoHud uses Meson build system
meson setup build \
    --prefix=/usr \
    --libdir=/usr/lib \
    --buildtype=release \
    -Dwith_xnvctrl=disabled \
    -Dwith_nvml=disabled
    """,
    configure_args = [],
    post_install = """
#!/bin/bash
set -e

cd "$SRC_DIR"
meson compile -C build
DESTDIR="$DESTDIR" meson install -C build

# Create mangohud launch script wrapper
mkdir -p "$DESTDIR/usr/bin"
cat > "$DESTDIR/usr/bin/mangohud" << 'EOF'
#!/bin/bash
# MangoHud wrapper script
export MANGOHUD=1
exec "$@"
EOF
chmod +x "$DESTDIR/usr/bin/mangohud"

# Install default configuration
mkdir -p "$DESTDIR/usr/share/doc/mangohud"
cat > "$DESTDIR/usr/share/doc/mangohud/MangoHud.conf.example" << 'EOF'
# MangoHud configuration file
# Place in ~/.config/MangoHud/MangoHud.conf

fps
frametime
cpu_stats
cpu_temp
gpu_stats
gpu_temp
ram
vram
position=top-left
EOF
    """,
    deps = [
        "//packages/linux/gaming/libraries/vulkan-tools:vulkan-tools",
    ],
    bdepend = [
        "//packages/linux/lang/python:python",
    ],
    visibility = ["PUBLIC"],
)
