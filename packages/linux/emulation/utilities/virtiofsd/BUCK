load("//defs:package_defs.bzl", "download_source", "autotools_package")
load("//defs:use_flags.bzl", "set_use_flags")

# virtiofsd - virtio-fs vhost-user device daemon
download_source(
    name = "virtiofsd-src",
    src_uri = "https://gitlab.com/virtio-fs/virtiofsd/-/archive/v1.11.1/virtiofsd-v1.11.1.tar.gz",
    sha256 = "e45a70b1c764378077f36c15c97975d5a0cc0f0534adbc7c24e5b62da6adb579",
    signature_required = False,
)

# USE flags: See use_flags.bzl for available flags

autotools_package(
    name = "virtiofsd",
    source = ":virtiofsd-src",
    version = "1.11.1",
    description = "virtio-fs vhost-user device daemon for sharing directories with guests",
    homepage = "https://virtio-fs.gitlab.io/",
    license = "Apache-2.0 AND BSD-3-Clause",
    env = {
        "CARGO_HOME": "/tmp/cargo",
    },
    pre_configure = """
cargo build --release
    """,
    post_install = """
#!/bin/bash
set -e

mkdir -p "$DESTDIR/usr/lib/qemu"
install -m 0755 target/release/virtiofsd "$DESTDIR/usr/lib/qemu/"

# Also create symlink in /usr/bin for convenience
mkdir -p "$DESTDIR/usr/bin"
ln -sf /usr/lib/qemu/virtiofsd "$DESTDIR/usr/bin/virtiofsd"

# Install systemd unit template
mkdir -p "$DESTDIR/usr/lib/systemd/system"
cat > "$DESTDIR/usr/lib/systemd/system/virtiofsd@.service" << 'EOF'
[Unit]
Description=virtiofsd - virtio-fs vhost-user device daemon for %i

[Service]
Type=simple
ExecStart=/usr/lib/qemu/virtiofsd --socket-path=/run/virtiofsd/%i.sock --shared-dir=/var/lib/virtiofsd/%i
RuntimeDirectory=virtiofsd
StateDirectory=virtiofsd/%i

[Install]
WantedBy=multi-user.target
EOF
    """,
    deps = [
        "//packages/linux/lang/rust:rust",
        "//packages/linux/system/libs/ipc/libcap-ng:libcap-ng",
        "//packages/linux/system/libs/ipc/libseccomp:libseccomp",
    ],
    visibility = ["PUBLIC"],
)
