load("//defs:package_defs.bzl", "download_source", "binary_package")
load("//defs:use_flags.bzl", "use_package", "set_use_flags", "use_dep")

download_source(
    name = "maddy-src",
    src_uri = "https://github.com/foxcpp/maddy/archive/v0.7.1.tar.gz",
    sha256 = "f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2",
)

binary_package(
    name = "maddy",
    srcs = [":maddy-src"],
    version = "0.7.1",
    description = "Composable all-in-one mail server",
    homepage = "https://maddy.email/",
    license = "GPL-3.0",
    install_script = """
        cd $SRCS/maddy-*

        export CGO_ENABLED=1
        export GOFLAGS="-buildmode=pie -trimpath"
        export LDFLAGS="-X github.com/foxcpp/maddy.Version=0.7.1"

        go build -ldflags "$LDFLAGS" -o maddy ./cmd/maddy
        go build -ldflags "$LDFLAGS" -o maddyctl ./cmd/maddyctl

        # Install binaries
        install -Dm755 maddy "$OUT/usr/bin/maddy"
        install -Dm755 maddyctl "$OUT/usr/bin/maddyctl"

        # Create directories
        mkdir -p "$OUT/etc/maddy"
        mkdir -p "$OUT/var/lib/maddy"
        mkdir -p "$OUT/var/log/maddy"
        mkdir -p "$OUT/run/maddy"

        # Install default config
        install -Dm644 maddy.conf "$OUT/etc/maddy/maddy.conf"

        # Install systemd service
        mkdir -p "$OUT/usr/lib/systemd/system"
        cat > "$OUT/usr/lib/systemd/system/maddy.service" << 'SERVICE'
[Unit]
Description=Maddy Mail Server
After=network.target

[Service]
Type=notify
User=maddy
Group=maddy
ExecStart=/usr/bin/maddy -config /etc/maddy/maddy.conf
ExecReload=/bin/kill -USR1 $MAINPID
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
SERVICE
    """,
    deps = [
        "//packages/linux/lang/go:go",
    ],
    visibility = ["PUBLIC"],
)
