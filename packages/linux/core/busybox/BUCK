load("//defs:package_defs.bzl", "download_source", "configure_make_package")
load("//defs:use_flags.bzl", "use_package", "set_use_flags")

use_package(
    name = "busybox",
    version = "1.36.1",
    src_uri = "https://busybox.net/downloads/busybox-1.36.1.tar.bz2",
    sha256 = "b8cc24c9574d809e7279c3be349795c5d5ceb6fdf19ca709f80cde50e47de314",
    description = "BusyBox combines tiny versions of many common UNIX utilities into a single small executable",
    homepage = "https://busybox.net/",
    license = "GPL-2.0",

    # USE flags this package supports
    iuse = [
        "static",
        "debug",
        "selinux",
        "pam",
    ],

    # Default USE flags
    use_defaults = ["static"],

    pre_configure = """
# Use default config and enable static linking for init
make defconfig
sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/' .config
# Disable tc which has kernel header incompatibilities
sed -i 's/CONFIG_TC=y/# CONFIG_TC is not set/' .config
""",
    make_args = [
        "CONFIG_PREFIX=$DESTDIR",
    ],
    post_install = """
# Create symlinks in standard locations
mkdir -p "$DESTDIR/bin" "$DESTDIR/sbin"
cd "$DESTDIR"
# busybox installs with CONFIG_PREFIX, symlinks are auto-created
""",
    visibility = ["PUBLIC"],
)
