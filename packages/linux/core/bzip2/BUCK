load("//defs:package_defs.bzl", "download_source", "autotools_package")
load("//defs:use_flags.bzl", "set_use_flags")

autotools_package(
    name = "bzip2",
    version = "1.0.8",
    src_uri = "https://mirrors.kernel.org/sourceware/bzip2/bzip2-1.0.8.tar.gz",
    sha256 = "ab5a03176ee106d3f0fa90e381da478ddae405918153cca248e682cd0c4a2269",
    auto_detect_signature=False,
    description = "High-quality data compressor",
    homepage = "https://sourceware.org/bzip2/",
    license = "bzip2-1.0.6",

    # USE flags this package supports
    iuse = [
        "static-libs",
    ],

    # Default USE flags
    use_defaults = [],

    pre_configure = """
# bzip2 doesn't have a configure script
# Skip configure step entirely
""",
    configure_args = [],
    make_args = [],
    post_install = """
# bzip2 has no standard configure/install, build manually (following Gentoo approach)
cd "$SRCDIR"

# Clean any stale object files first
rm -f *.o *.so* *.a bzip2 bzip2recover

# Step 1: Build shared library FIRST (like Gentoo)
# Make sure we have -fPIC for shared library build
make -f Makefile-libbz2_so all \
  CC=cc \
  CFLAGS="-fpic -fPIC -Wall -Winline -O2 -fno-stack-protector"

# Step 2: Create symlink (like Gentoo does to avoid linking against static lib)
ln -sf libbz2.so.1.0.8 libbz2.so

# Step 3: Build static library and binaries with -fPIC to avoid conflicts
make -f Makefile all \
  CC=cc \
  CFLAGS="-Wall -Winline -O2 -fPIC -fno-stack-protector"

# Install shared libraries
mkdir -p "$DESTDIR/usr/lib"
cp -a libbz2.so.1.0.8 "$DESTDIR/usr/lib/"

# Install binaries
mkdir -p "$DESTDIR/usr/bin"
cp -f bzip2 "$DESTDIR/usr/bin/"
ln -sf bzip2 "$DESTDIR/usr/bin/bunzip2"
ln -sf bzip2 "$DESTDIR/usr/bin/bzcat"
cp -f bzip2recover "$DESTDIR/usr/bin/"

# Install static library
mkdir -p "$DESTDIR/usr/lib"
cp -f libbz2.a "$DESTDIR/usr/lib/"

# Install headers
mkdir -p "$DESTDIR/usr/include"
cp -f bzlib.h "$DESTDIR/usr/include/"

# Install man pages
mkdir -p "$DESTDIR/usr/share/man/man1"
cp -f bzip2.1 "$DESTDIR/usr/share/man/man1/"
ln -sf bzip2.1 "$DESTDIR/usr/share/man/man1/bunzip2.1"
ln -sf bzip2.1 "$DESTDIR/usr/share/man/man1/bzcat.1"

# Fix shared library symlinks (like Gentoo)
cd "$DESTDIR/usr/lib"
ln -sf libbz2.so.1.0.8 libbz2.so.1.0
ln -sf libbz2.so.1.0.8 libbz2.so.1
ln -sf libbz2.so.1.0.8 libbz2.so
""",
    visibility = ["PUBLIC"],
)
