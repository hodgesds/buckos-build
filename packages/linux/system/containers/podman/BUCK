load("//defs:package_defs.bzl", "download_source", "ebuild_package")

# =============================================================================
# Podman Ecosystem
# =============================================================================

# containers-common - Common configuration and documentation for containers
download_source(
    name = "containers-common-src",
    src_uri = "https://github.com/containers/common/archive/refs/tags/v0.58.0.tar.gz",
    sha256 = "0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e",
)

ebuild_package(
    name = "containers-common",
    source = ":containers-common-src",
    version = "0.58.0",
    description = "Common configuration and documentation for container tools",
    homepage = "https://github.com/containers/common",
    license = "Apache-2.0",
    src_install = """
mkdir -p "$DESTDIR/etc/containers"
mkdir -p "$DESTDIR/usr/share/containers"

# Install default configuration files
install -m 644 pkg/config/containers.conf "$DESTDIR/etc/containers/containers.conf" || true
install -m 644 pkg/config/registries.conf "$DESTDIR/etc/containers/registries.conf" || true
cat > "$DESTDIR/etc/containers/storage.conf" << 'EOF'
[storage]
driver = "overlay"
runroot = "/run/containers/storage"
graphroot = "/var/lib/containers/storage"

[storage.options]
additionalimagestores = []

[storage.options.overlay]
mountopt = "nodev,metacopy=on"
EOF

cat > "$DESTDIR/etc/containers/policy.json" << 'EOF'
{
    "default": [
        {
            "type": "insecureAcceptAnything"
        }
    ],
    "transports": {
        "docker-daemon": {
            "": [
                {
                    "type": "insecureAcceptAnything"
                }
            ]
        }
    }
}
EOF
""",
    visibility = ["PUBLIC"],
)

# podman - Container management tool
download_source(
    name = "podman-src",
    src_uri = "https://github.com/containers/podman/archive/refs/tags/v5.0.2.tar.gz",
    sha256 = "1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f",
)

ebuild_package(
    name = "podman",
    source = ":podman-src",
    version = "5.0.2",
    description = "A tool for managing OCI containers and pods",
    homepage = "https://podman.io",
    license = "Apache-2.0",
    src_compile = """
export CGO_ENABLED=1
export BUILDTAGS="seccomp exclude_graphdriver_btrfs exclude_graphdriver_devicemapper"

make BUILDTAGS="$BUILDTAGS" PREFIX=/usr
""",
    src_install = """
export BUILDTAGS="seccomp exclude_graphdriver_btrfs exclude_graphdriver_devicemapper"
make BUILDTAGS="$BUILDTAGS" PREFIX=/usr DESTDIR="$DESTDIR" install

# Install completions
mkdir -p "$DESTDIR/usr/share/bash-completion/completions"
mkdir -p "$DESTDIR/usr/share/zsh/site-functions"
mkdir -p "$DESTDIR/usr/share/fish/vendor_completions.d"
./bin/podman completion bash > "$DESTDIR/usr/share/bash-completion/completions/podman" || true
./bin/podman completion zsh > "$DESTDIR/usr/share/zsh/site-functions/_podman" || true
./bin/podman completion fish > "$DESTDIR/usr/share/fish/vendor_completions.d/podman.fish" || true
""",
    rdepend = [
        "//packages/linux/system/libs/ipc/libseccomp:libseccomp",
        "//packages/linux/system/libs/crypto/gpgme:gpgme",
        "//packages/linux/system/containers/runtime:crun",
        "//packages/linux/system/containers/runtime:conmon",
        "//packages/linux/system/containers/network:cni-plugins",
        "//packages/linux/system/containers/network:netavark",
        "//packages/linux/system/containers/network:aardvark-dns",
        "//packages/linux/system/containers/podman:containers-common",
        "//packages/linux/system/containers/storage:fuse-overlayfs",
        "//packages/linux/system/containers/network:slirp4netns",
    ],
    bdepend = [
        "//packages/linux/lang/go:go",
    ],
    visibility = ["PUBLIC"],
)

# buildah - Container image builder
download_source(
    name = "buildah-src",
    src_uri = "https://github.com/containers/buildah/archive/refs/tags/v1.35.3.tar.gz",
    sha256 = "2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a",
)

ebuild_package(
    name = "buildah",
    source = ":buildah-src",
    version = "1.35.3",
    description = "A tool for building OCI container images",
    homepage = "https://buildah.io",
    license = "Apache-2.0",
    src_compile = """
export CGO_ENABLED=1
export BUILDTAGS="seccomp exclude_graphdriver_btrfs exclude_graphdriver_devicemapper"

make BUILDTAGS="$BUILDTAGS" PREFIX=/usr
""",
    src_install = """
export BUILDTAGS="seccomp exclude_graphdriver_btrfs exclude_graphdriver_devicemapper"
make BUILDTAGS="$BUILDTAGS" PREFIX=/usr DESTDIR="$DESTDIR" install

# Install completions
mkdir -p "$DESTDIR/usr/share/bash-completion/completions"
./bin/buildah completion bash > "$DESTDIR/usr/share/bash-completion/completions/buildah" || true
""",
    rdepend = [
        "//packages/linux/system/libs/ipc/libseccomp:libseccomp",
        "//packages/linux/system/libs/crypto/gpgme:gpgme",
        "//packages/linux/system/containers/runtime:crun",
        "//packages/linux/system/containers/podman:containers-common",
        "//packages/linux/system/containers/storage:fuse-overlayfs",
        "//packages/linux/system/containers/network:slirp4netns",
    ],
    bdepend = [
        "//packages/linux/lang/go:go",
    ],
    visibility = ["PUBLIC"],
)

# skopeo - Container image inspection and transport
download_source(
    name = "skopeo-src",
    src_uri = "https://github.com/containers/skopeo/archive/refs/tags/v1.15.1.tar.gz",
    sha256 = "3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b",
)

ebuild_package(
    name = "skopeo",
    source = ":skopeo-src",
    version = "1.15.1",
    description = "Command line utility for container image operations",
    homepage = "https://github.com/containers/skopeo",
    license = "Apache-2.0",
    src_compile = """
export CGO_ENABLED=1
export BUILDTAGS="exclude_graphdriver_btrfs exclude_graphdriver_devicemapper"

make BUILDTAGS="$BUILDTAGS" bin/skopeo
""",
    src_install = """
mkdir -p "$DESTDIR/usr/bin"
install -m 755 bin/skopeo "$DESTDIR/usr/bin/skopeo"

# Install completions
mkdir -p "$DESTDIR/usr/share/bash-completion/completions"
./bin/skopeo completion bash > "$DESTDIR/usr/share/bash-completion/completions/skopeo" || true
""",
    rdepend = [
        "//packages/linux/system/libs/crypto/gpgme:gpgme",
        "//packages/linux/system/containers/podman:containers-common",
    ],
    bdepend = [
        "//packages/linux/lang/go:go",
    ],
    visibility = ["PUBLIC"],
)

# podman-compose - Run docker-compose files with Podman
download_source(
    name = "podman-compose-src",
    src_uri = "https://github.com/containers/podman-compose/archive/refs/tags/v1.0.6.tar.gz",
    sha256 = "4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c",
)

ebuild_package(
    name = "podman-compose",
    source = ":podman-compose-src",
    version = "1.0.6",
    description = "Run docker-compose.yml files using Podman",
    homepage = "https://github.com/containers/podman-compose",
    license = "GPL-2.0",
    src_install = """
mkdir -p "$DESTDIR/usr/bin"
mkdir -p "$DESTDIR/usr/lib/python3/dist-packages"
install -m 755 podman_compose.py "$DESTDIR/usr/bin/podman-compose"
""",
    rdepend = [
        "//packages/linux/lang/python:python",
        "//packages/linux/dev-python/pyyaml:pyyaml",
        "//packages/linux/system/containers/podman:podman",
    ],
    visibility = ["PUBLIC"],
)
