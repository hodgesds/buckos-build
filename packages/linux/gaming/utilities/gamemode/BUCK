# GameMode - Optimize Linux system performance for gaming
# Developed by Feral Interactive

load("//defs:package_defs.bzl", "configure_make_package", "download_source")
load("//defs:use_flags.bzl", "use_package", "set_use_flags")

download_source(
    name = "gamemode-src",
    src_uri = "https://github.com/FeralInteractive/gamemode/archive/refs/tags/1.8.2.tar.gz",
    sha256 = "3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5",
)

# USE flags: See use_flags.bzl for available flags

configure_make_package(
    name = "gamemode",
    source = ":gamemode-src",
    version = "1.8.2",
    description = "Optimize Linux system performance on demand",
    homepage = "https://github.com/FeralInteractive/gamemode",
    license = "BSD-3-Clause",
    pre_configure = """
# GameMode uses Meson build system
meson setup build \
    --prefix=/usr \
    --libdir=/usr/lib \
    --buildtype=release \
    -Dwith-sd-bus-provider=no-daemon \
    -Dwith-pam-group=games
    """,
    configure_args = [],
    post_install = """
#!/bin/bash
set -e

cd "$SRC_DIR"
meson compile -C build
DESTDIR="$DESTDIR" meson install -C build

# Install systemd user service
mkdir -p "$DESTDIR/usr/lib/systemd/user"
cat > "$DESTDIR/usr/lib/systemd/user/gamemoded.service" << 'EOF'
[Unit]
Description=GameMode Daemon

[Service]
Type=dbus
BusName=com.feralinteractive.GameMode
ExecStart=/usr/bin/gamemoded
Restart=on-failure

[Install]
WantedBy=default.target
EOF

# Install D-Bus service
mkdir -p "$DESTDIR/usr/share/dbus-1/services"
cat > "$DESTDIR/usr/share/dbus-1/services/com.feralinteractive.GameMode.service" << 'EOF'
[D-BUS Service]
Name=com.feralinteractive.GameMode
Exec=/usr/bin/gamemoded
EOF

# Create default configuration
mkdir -p "$DESTDIR/etc/gamemode.d"
cat > "$DESTDIR/etc/gamemode.d/gamemode.ini" << 'EOF'
[general]
; GameMode default configuration
renice = 10

[gpu]
; GPU optimizations
apply_gpu_optimisations = accept-responsibility
gpu_device = 0

[custom]
; Custom scripts to run
start=/usr/bin/true
end=/usr/bin/true
EOF
    """,
    deps = [
        "//packages/linux/core/glibc:glibc",
    ],
    visibility = ["PUBLIC"],
)
