load("@prelude//platforms:defs.bzl", "execution_platform", "host_configuration")
load(":defs.bzl", "re_execution_platform")

# Target platform detection
platform(
    name = "detect",
    constraint_values = [],
)

# Default execution platform (with remote execution enabled)
re_execution_platform(
    name = "default",
    cpu_configuration = host_configuration.cpu,
    os_configuration = host_configuration.os,
    use_windows_path_separators = host_configuration.os == "windows",
)

# Local-only execution platform (for debugging or when RE is unavailable)
execution_platform(
    name = "local",
    cpu_configuration = host_configuration.cpu,
    os_configuration = host_configuration.os,
    use_windows_path_separators = host_configuration.os == "windows",
)

# x86_64 Linux target
platform(
    name = "linux-x86_64",
    constraint_values = [
        "prelude//cpu/constraints:x86_64",
        "prelude//os/constraints:linux",
    ],
)

# Configuration for building packages
constraint_setting(
    name = "build_type",
)

constraint_value(
    name = "release",
    constraint_setting = ":build_type",
)

constraint_value(
    name = "debug",
    constraint_setting = ":build_type",
)

# Platform targeting constraint setting
# Used to tag packages by their supported platforms
constraint_setting(
    name = "target_platform",
    visibility = ["PUBLIC"],
)

# Platform constraint values
constraint_value(
    name = "linux",
    constraint_setting = ":target_platform",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "bsd",
    constraint_setting = ":target_platform",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "macos",
    constraint_setting = ":target_platform",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "windows",
    constraint_setting = ":target_platform",
    visibility = ["PUBLIC"],
)

# Distribution compatibility constraint setting
# Used to tag packages by their distribution compatibility
constraint_setting(
    name = "distro_compat",
    visibility = ["PUBLIC"],
)

# Distribution compatibility values
constraint_value(
    name = "buckos-native",
    constraint_setting = ":distro_compat",
    visibility = ["PUBLIC"],
)

constraint_value(
    name = "fedora",
    constraint_setting = ":distro_compat",
    visibility = ["PUBLIC"],
)

# Multi-platform target platforms
platform(
    name = "linux-target",
    constraint_values = [
        ":linux",
    ],
    visibility = ["PUBLIC"],
)

platform(
    name = "bsd-target",
    constraint_values = [
        ":bsd",
    ],
    visibility = ["PUBLIC"],
)

platform(
    name = "macos-target",
    constraint_values = [
        ":macos",
    ],
    visibility = ["PUBLIC"],
)

platform(
    name = "windows-target",
    constraint_values = [
        ":windows",
    ],
    visibility = ["PUBLIC"],
)
