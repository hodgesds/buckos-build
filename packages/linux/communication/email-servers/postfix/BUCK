load("//defs:package_defs.bzl", "download_source", "autotools_package")
load("//defs:use_flags.bzl", "set_use_flags")

download_source(
    name = "postfix-src",
    src_uri = "https://de.postfix.org/ftpmirror/official/postfix-3.9.0.tar.gz",
    sha256 = "56f5e420e7c25455a4e96c19b672f80f9a0a35fb5becc9247c9e3d5dcc617f34",
    auto_detect_signature = False,
)

# USE flags: See use_flags.bzl for available flags

autotools_package(
    name = "postfix",
    source = ":postfix-src",
    version = "3.9.0",
    description = "Fast, secure, and flexible mail transfer agent",
    homepage = "https://www.postfix.org/",
    license = "IPL-1.0 EPL-2.0",
    pre_configure = """
make makefiles \
    CCARGS='-DUSE_TLS -DUSE_SASL_AUTH -DUSE_CYRUS_SASL -DHAS_LDAP -DHAS_SQLITE -DHAS_PCRE' \
    AUXLIBS='-lssl -lcrypto -lsasl2 -lldap -llber -lsqlite3 -lpcre2-8 -lpthread'
""",
    configure_args = [],
    make_args = [],
    post_install = """
mkdir -p "$DESTDIR/etc/postfix"
mkdir -p "$DESTDIR/var/spool/postfix"
mkdir -p "$DESTDIR/var/lib/postfix"

# Install default configuration
install -Dm644 conf/main.cf "$DESTDIR/etc/postfix/main.cf"
install -Dm644 conf/master.cf "$DESTDIR/etc/postfix/master.cf"

# Create required directories
for dir in active bounce corrupt defer deferred flush hold incoming maildrop pid private public saved trace; do
    mkdir -p "$DESTDIR/var/spool/postfix/$dir"
done
""",
    deps = [
        "//packages/linux/network/openssl:openssl",
    ],
    visibility = ["PUBLIC"],
)
