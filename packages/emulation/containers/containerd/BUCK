load("//defs:package_defs.bzl", "download_source", "configure_make_package")

# containerd - Industry-standard container runtime
download_source(
    name = "containerd-src",
    src_uri = "https://github.com/containerd/containerd/archive/refs/tags/v1.7.23.tar.gz",
    sha256 = "d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2",
)

configure_make_package(
    name = "containerd",
    source = ":containerd-src",
    version = "1.7.23",
    description = "Industry-standard container runtime with emphasis on simplicity and portability",
    homepage = "https://containerd.io/",
    license = "Apache-2.0",
    env = {
        "CGO_ENABLED": "1",
        "GO111MODULE": "on",
        "GOFLAGS": "-mod=vendor",
    },
    configure_args = [],
    pre_configure = """
# Build containerd
make BUILDTAGS='seccomp apparmor' binaries
    """,
    post_install = """
#!/bin/bash
set -e

# Install binaries
mkdir -p "$DESTDIR/usr/bin"
install -m 0755 bin/containerd "$DESTDIR/usr/bin/"
install -m 0755 bin/containerd-shim "$DESTDIR/usr/bin/"
install -m 0755 bin/containerd-shim-runc-v1 "$DESTDIR/usr/bin/"
install -m 0755 bin/containerd-shim-runc-v2 "$DESTDIR/usr/bin/"
install -m 0755 bin/ctr "$DESTDIR/usr/bin/"

# Install systemd service
mkdir -p "$DESTDIR/usr/lib/systemd/system"
cat > "$DESTDIR/usr/lib/systemd/system/containerd.service" << 'EOF'
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/bin/containerd
Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=1048576
TasksMax=infinity
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
EOF

# Create default configuration
mkdir -p "$DESTDIR/etc/containerd"
containerd config default > "$DESTDIR/etc/containerd/config.toml" 2>/dev/null || true
    """,
    deps = [
        "//packages/lang/go:go",
        "//packages/emulation/containers/runc:runc",
        "//packages/system/libs/libseccomp:libseccomp",
    ],
    visibility = ["PUBLIC"],
)
