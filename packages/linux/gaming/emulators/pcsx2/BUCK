# PCSX2 - PlayStation 2 emulator
# Highly compatible PS2 emulator with great performance

load("//defs:package_defs.bzl", "configure_make_package", "download_source")
load("//defs:use_flags.bzl", "use_package", "set_use_flags")

download_source(
    name = "pcsx2-src",
    src_uri = "https://github.com/PCSX2/pcsx2/archive/refs/tags/v2.1.265.tar.gz",
    sha256 = "d5558cd419c8d46bdc958064cb97f963d1ea793866414c025906ec15033512ed",
)

# USE flags: See use_flags.bzl for available flags

configure_make_package(
    name = "pcsx2",
    source = ":pcsx2-src",
    version = "2.1.265",
    description = "PlayStation 2 emulator",
    homepage = "https://pcsx2.net/",
    license = "GPL-3.0",
    pre_configure = """
# PCSX2 uses CMake
mkdir -p build
cd build
cmake .. \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DUSE_VULKAN=ON \
    -DWAYLAND_API=ON \
    -DX11_API=ON \
    -DENABLE_SETCAP=OFF \
    -DDISABLE_ADVANCE_SIMD=OFF \
    -DUSE_SYSTEM_SDL2=ON \
    -DUSE_SYSTEM_ZSTD=ON
    """,
    configure_args = [],
    post_install = """
#!/bin/bash
set -e

cd "$SRC_DIR/build"
make -j$(nproc)
make DESTDIR="$DESTDIR" install

# Create configuration directory structure info
mkdir -p "$DESTDIR/usr/share/doc/pcsx2"
cat > "$DESTDIR/usr/share/doc/pcsx2/README" << 'EOF'
PCSX2 - PlayStation 2 Emulator

Configuration: ~/.config/PCSX2/
BIOS: Place PS2 BIOS files in ~/.config/PCSX2/bios/

Required BIOS files:
- Your legally dumped PS2 BIOS files

Performance tips:
- Use Vulkan renderer for best performance
- Enable MTVU (Multi-Threaded microVU1)
- Use native resolution or 2x for good quality/performance balance
- Enable hardware rendering for 3D games

Controller setup:
- Supports DualShock 2 emulation
- Can map keyboard, gamepad, or use DS4/DualSense controllers
EOF

# Desktop entry should be installed by CMake
# Ensure icon is properly installed
mkdir -p "$DESTDIR/usr/share/icons/hicolor/256x256/apps"
    """,
    deps = [
        "//packages/linux/gaming/libraries/sdl2:sdl2",
        "//packages/linux/gaming/libraries/vulkan-tools:vulkan-tools",
    ],
    visibility = ["PUBLIC"],
)
